{"_id":"1WjzN8HKjr3Q02W6","name":"DAERollTable","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"//DAERollTable Tablename\nif(args[0] === \"each\"){\n    game.tables.getName(args[1]).draw();\n}","author":"X4uo406iXTm4HkVN","img":"icons/svg/d20.svg","actorIds":[]}
{"_id":"1rqDqtjNNPzhH73i","name":"RollTable: Orientation","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"icons/svg/d20-grey.svg","tooltip":"RollTable: Orientation","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.getName(\"Orientation\").draw();","author":"X4uo406iXTm4HkVN","img":"icons/tools/navigation/compass-brass-blue-red.webp","actorIds":[]}
{"_id":"51UjG9KrG0bzOCqO","name":"Reoccuring Effect","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"exportSource":{"world":"testWorld","system":"dnd5e","coreVersion":"0.7.9","systemVersion":"1.2.4"},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// arguments\n//args[0] --> \"on\", \"each\", \"off\"\n//args[1] --> the level the spell was cast (usually @item.level)\n//args[2] --> save allowed (\"yes\"/\"no\"), e.g. damage effects that can only be ended using an action)\n//args[3] --> damage mode \n//              \"none\" for effects without damage\n//              \"flat\" for fixed damage from argument baseDamage\n//              \"scaling\" for damage scaling based on castLevel\n//args[4] --> damage type\n//args[5] --> baseDamage (e.g. 1d6)\n//args[6] --> scalingDieCount (e.g. 2 for 2dX scaling per spell level)\n//args[7] --> scalingDieSize (e.g. d6 for Xd6 scaling per spell level)\n//args[8] --> saveType (if spell does not contain a saving throw, e.g. Paladin smites)\n//args[9] --> flat DC\n\nif (args[0] === \"each\") {\n\n  const lastArg = args[args.length-1];\n  const castLevel = args[1];\n  const saveAllowed = args[2];\n  const damageMode = args[3];\n  const damageType = args[4];\n  const baseDamage = args[5];\n  const scalingDieCount = args[6];\n  const scalingDieSize = args[7];\n  let saveType = args[8];\n  let dc = args[9];\n\n  let target;\n  if (lastArg.tokenId) target = canvas.tokens.get(lastArg.tokenId);\n    else target = game.actors.get(lastArg.actorId).getActiveTokens(0);\n  const effect = lastArg.effectId;\n  const casterItem = lastArg.efData.flags.dae.itemData;\n  const casterItemLevel = casterItem.data.level;\n  const [_1, casterId, _2, _3] = lastArg.efData.origin.split(\".\")\n  const caster = game.actors.get(casterId);\n  const casterT = caster.isToken ? caster.token : caster.getActiveTokens[0];\n\n  let effectEnds;\n  \n  //Determine saveType and dc if save is allowed and ask for save\n  //Priority for save: 1) values in args[8] and args[9]\n  //          2) values stored in the item\n  if (saveAllowed === \"yes\") {\n      if (saveType === null) {\nChatMessage.create({ content: \"Hallo\" });   \n        saveType = casterItem.data.save.ability;\n        dc = casterItem.data.save.dc;\n      }\n      const flavor = `${CONFIG.DND5E.abilities[saveType]} DC${dc} ${casterItem.name}`;  \n      let save = (await target.actor.rollAbilitySave(saveType, {flavor, fastforward: true, chatMessage: true}));\n      if (save.total >= dc) effectEnds = true;\n        else effectEnds = false;\n  } else effectEnds = false;\n\n\n  //Delete effect if saved; otherwise do damage, if effect has damage over time\n  if (effectEnds) {\n    if (target) target.actor.deleteEmbeddedEntity(\"ActiveEffect\", effect);\n  } else {\n    let damageRoll;\n    if (damageMode != \"none\") {\n      let damageFormula;\n      if (damageMode === \"scaling\" && castLevel-casterItemLevel > 0) {\n        damageFormula = baseDamage + \"+\" + (castLevel-casterItemLevel) * scalingDieCount + scalingDieSize;\n      } else {\n        damageFormula = baseDamage;\n      }\n      damageRoll = new Roll(damageFormula).roll();\n      new MidiQOL.DamageOnlyWorkflow(caster, casterT, damageRoll.total, damageType, [target], damageRoll, {flavor: `Damage for ${casterItem.name}`, itemCardId: \"new\", itemData: casterItem})\n    }\n  }\n}","author":"iv1xD7Xolui8SRLL","img":"systems/dnd5e/icons/skills/affliction_02.jpg","actorIds":[]}
{"_id":"88LJ6VPHI1cZEGsj","name":"#[CF_tempEntity]","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"chat","flags":{"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000","name":"Roll Tables","children":["w8MExLHMIGt1K4KO","HEbMljxKEOZBEgYp","ilOnM4PONpYPZ8uV","1rqDqtjNNPzhH73i","GCmalnLgLekr0TXS","O44VSFhNABFnWEKn"],"folderPath":[]}},"scope":"global","command":"","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","actorIds":[]}
{"name":"DAEAurax","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// DAEAura @token @item self\nconsole.log(args);\nlet atoken = canvas.tokens.get(args[1]);\nlet lastArg = args[args.length-1];\nlet effectId = lastArg.effectId;\nlet atarget=[];\nlet self = (args[3]!== lastArg && args[3] == 'self') ? true : false;\nif(args[0] === 'on' || args[0] === 'each'){\n    if(self && atoken.actor.id != lastArg.actorId) return;\n    canvas.tokens.placeables.map(entity=>{\n        entity.actor.effects.map(ef=>{\n            if(ef.data.origin == lastArg.origin && ef.data.label == lastArg.efData.label){\n                if(entity.actor.id == lastArg.actorId && self){\n                    atarget.push(entity);\n                }else if(entity.actor.id != lastArg.actorId){\n                    atarget.push(entity);\n                }\n            }\n        });\n    });\n    console.log(atoken, atarget);\n    let saveTargets = game.user.targets;\n        game.user.targets = new Set(atarget);\n        try {\n            let damageItem = (typeof args[2] === 'string') ? atoken.actor.items.find(i => i.name === args[2]) : atoken.actor.items.find(i => i.id === args[2]._id);\n            console.log(damageItem);\n            damageItem.roll();\n        } finally {\n            game.user.targets = saveTargets;\n        }\n    \n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/wind-grasp-magenta-2.jpg","actorIds":[],"_id":"8VJiqz5mdiN7Qgga"}
{"_id":"8oJ4SPjhNWFb7Fn1","name":"DAEConditions","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// args[0] = conditions\n//args[1] = tactor;\nlet rm = 0;\nlet verif;\nlet sTypes;\n    if(args[0] != false){\n        for (let c of args[0]){\n            let cond = c.split(':');\n            cond[0] = cond[0].trim();\n            switch (cond[0]) {\n                case 'Condition':\n                    if(game.cub.hasCondition(cond[1].trim(), args[1])) rm ++;\n                    break;\n                case 'Size':\n                    sTypes = cond[1].trim().split(',');\n                    if(sTypes.includes(args[1].data.data.traits.size)) rm++;\n                    break;\n                case 'Alignment':\n                    verif = args[1].data.data.details.alignment.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                case 'Type':\n                    verif = args[1].data.data.details.type.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                default:\n            }\n        }\n    }\n    return rm;","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"9x6dLAlAaqygjfmS","name":"DAEAura","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// DAEAura @token\nif(args[1] == 0) return;\nif(args[0] == \"off\") return;\nlet atarget=[];\nconst lastArg = args[args.length-1];\nif(args[0] == \"each\" || \"on\") {\n    let damage = \"1d6\";\n    let dtype = \"\";\n\n    let org = lastArg.origin.split('.');\n    let aactor = game.actors.get(org[1]);\n    console.log(aactor, \"ACtor\");\n    let tactor = canvas.tokens.get(lastArg.tokenId);\n    let item = aactor.items.find(i => i.id === org[3]);\n    let ttoken = await canvas.tokens.placeables.find(x=>x.actor.id == org[1]);\n    console.log(ttoken, \"token\");\n    let saveTargets = game.user.targets;\n    game.user.targets = new Set(atarget);\n    try {\n            item.roll();\n        } finally {\n            game.user.targets = saveTargets;\n        }\n    \n    \n    /*\n    let damageRoll = new Roll(damage).roll(); // could be passed as an argument\n    new MidiQOL.DamageOnlyWorkflow(aactor, ttoken, damageRoll.total, dtype, [tactor], damageRoll, {flavor: `Damage from Aura ${item.name} - damage type ${dtype}`, item})\n    */\n}","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"GCmalnLgLekr0TXS","name":"RollTable: Research Complications","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"icons/svg/d20-grey.svg","tooltip":"RollTable: Research Complications","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.getName(\"Research Complications\").draw();","author":"X4uo406iXTm4HkVN","img":"icons/sundries/books/book-embossed-gold-red.webp","actorIds":[]}
{"_id":"HEbMljxKEOZBEgYp","name":"RollTable: Complications","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"icons/svg/d20-grey.svg","tooltip":"RollTable: Complications","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.getName(\"Complications\").draw();","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/red_28.jpg","actorIds":[]}
{"_id":"Hfmoyuuz29aupbRc","name":"DAESelfRepeat","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// usado apra marcar qual inimigo vai repetir o ataque\n// SelfRepeat Engulf end\n\nconst lastArg = args[args.length-1];\nlet effectId = lastArg.effectId;\nlet macroRepeat = (args[2] && args[2] != lastArg)? 'endEveryTurn':'startEveryTurn';\n\nconsole.log(\"Self Repeat args are \", ...args);\nlet tgtoken;\nlet tgactor;\nif (lastArg.tokenId){\n    tgtoken = canvas.tokens.get(lastArg.tokenId);\n    tgactor = tgtoken.actor;\n} \nelse tgactor = game.actors.get(lastArg.actorId);\n\nlet org = lastArg.origin.split('.');\nlet orgItem = lastArg.efData.flags.dae.itemData;\nlet aCondition = orgItem.data.activation.condition;\nlet conditions = (aCondition)? aCondition.split(',') : false;\n\nlet REPEAT_EFFECT = {\n    label: `Repeat_${tgtoken.name}`,\n    icon: lastArg.efData.icon,\n    changes: [\n      {key: \"macro.execute\", \n      value: `DAEAttack ${_token.id} ${lastArg.tokenId} ${args[1]}`, \n      mode: ACTIVE_EFFECT_MODES.CUSTOM\n      }\n    ],\n    flags: {\n        dae: {\n            macroRepeat: macroRepeat\n        }\n    },\n    transfer: true,\n  };\n  if(args[0] === 'on'){\n    let activeConditions = await _token.actor.getEmbeddedCollection(\"ActiveEffect\")\n    .find(a=> a.label === `Repeat_${tgtoken.name}`);\n    if(!activeConditions){\n        let upItem = Object.assign(REPEAT_EFFECT, {_id: lastArg.efData._id});\n        await _token.actor.createEmbeddedEntity(\"ActiveEffect\", [REPEAT_EFFECT]);  \n    }\n  }","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.2_72.png","actorIds":[]}
{"name":"Invisibility","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"//DAE Macro Execute, Effect Value = \"Macro Name\" @target\n\nlet target = canvas.tokens.get(args[1])\nif (args[0] === \"on\") {\n    ChatMessage.create({ content: `${target.name} turns invisible` });\n    target.update({ \"hidden\": true });\n}\nif (args[0] === \"off\") {\n    ChatMessage.create({ content: `${target.name} re-appears` });\n    target.update({ \"hidden\": false });\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/fog-sky-2.jpg","actorIds":[],"_id":"KGYWNvGt3zgVU1A9"}
{"name":"RollTable: Segredos dos Personagens","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.get(\"5rawM9Iah0vtVebQ\").draw();","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/red_25.jpg","actorIds":[],"_id":"O44VSFhNABFnWEKn"}
{"_id":"RkAsCLVcGEDyK8We","name":"#[CF_tempEntity]","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"chat","flags":{"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000","name":"DAE","children":["qIRyPTF4E1p6VT8r","hpkqSIiiNHkFWYpO","Zkr624s95L1GMhDn","9x6dLAlAaqygjfmS","kFAk71loNB02sUsD","8oJ4SPjhNWFb7Fn1","Rue2uR5U72u8ND7v","octT6lsJNX0dCiKV","gPmEcO9hroTTBH7t","1WjzN8HKjr3Q02W6","Hfmoyuuz29aupbRc","lUvYFZQ8Ls6tncil","NFOnsUtAmd6FbndR","51UjG9KrG0bzOCqO","qozoBrs5Q7KT49Mm","VGYTyo5xF7Bs2Vlb","8VJiqz5mdiN7Qgga","lsauMPfelmTKiq2E","KGYWNvGt3zgVU1A9"],"folderPath":[]}},"scope":"global","command":"","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"Rue2uR5U72u8ND7v","name":"DAEDamage","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"let adamage = args[1];\nlet atype = args[2];\nlet atoken = canvas.tokens.get(args[3]);\nlet atarget = canvas.tokens.get(args[4]);\nlet lastArg = args[args.length-1];\nlet casterItem = lastArg.efData.flags.dae.itemData;\n\nconsole.log(atoken, atarget);\n//let aactor = game.actors.get(atoken.actor.id)\n\nif (args[0] === \"each\") {\n    let damageRoll = new Roll(adamage).roll();\n    new MidiQOL.DamageOnlyWorkflow(atoken.actor, atoken, damageRoll.total, atype, [atarget], damageRoll,{flavor: `Damage type - (${atype})`, itemCardId: \"new\", itemData: casterItem})\n    \n}","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.4_85.png","actorIds":[]}
{"name":"DAE Life Drain","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"const lastArg = args[args.length-1];\nlet adamage = args[1];\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n\n\nif (args[0] === \"on\") {\n    let max = tactor.data.data.attributes.hp.max - (adamage);\n    tactor.update ({\n        \"data.attributes.hp.max\": max\n    });\n}\nif (args[0] === \"off\") {\n    let max = tactor.data.data.attributes.hp.max + (adamage);\n    tactor.update ({\n        \"data.attributes.hp.max\": max\n    });\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/violet_28.jpg","actorIds":[],"_id":"VGYTyo5xF7Bs2Vlb"}
{"_id":"Zkr624s95L1GMhDn","name":"DAEAttackEnd","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// DAEAttackEnd @item|itemName\nif(args){\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nconsole.log(\"ARGS\",args);\n\nlet ttoken =  canvas.tokens.get(lastArg.tokenId);\nlet tactor = ttoken.actor;\n\nlet org = (lastArg.origin != undefined) ? lastArg.origin.split('.') : args[1];\n\nconsole.log(ttoken.name);\n\nlet item= tactor.items.getName(args[1]);\n\nconsole.log(\"DAMAGE\",item);\nlet aCondition = item.data.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nconsole.log(\"Conditions\",conditions, aCondition);\n\nlet rm = await DAEConditions.execute(conditions, tactor);\n\nif(args[0] == \"off\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n         new MidiQOL.DamageOnlyWorkflow(actor, token, damageRoll.total, dtype, [token], damageRoll, {flavor: `Failed Save for ${item.name} - damage type ${dtype}`, item});\n    }\n}\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/violet_20.jpg","actorIds":[]}
{"_id":"gPmEcO9hroTTBH7t","name":"DAEGrappler","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// DAEGrappler true\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nlet org = lastArg.origin.split('.');\nlet aactor = game.actors.get(org[1]);\nlet skill = (tactor.data.data.skills.ath.total >= tactor.data.data.skills.acr.total) ? 'ath' : 'acr';\nlet item = lastArg.efData.flags.dae.itemData;\nconst DC = (lastArg == args[1]) ? false : parseInt(item.data.save.dc);\n\nlet flavor = '';\nlet aCondition = item.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nlet rm = await DAEConditions.execute(conditions, tactor);\nif (args[0] === \"on\") {\n    console.log(conditions, rm, conditions.length);\n    if((conditions && rm == conditions.length) || conditions == false){\n        if(token.id != lastArg.tokenId && lastArg == args[1]){\n            await aactor.rollSkill('ath').then(async (result) => {\n                let res = await tactor.rollSkill(skill, {flavor, fastforward: true});\n                if(result.total <= res.total){\n                    await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n                }else{\n                    let aef = tactor.getEmbeddedCollection(\"ActiveEffect\").find(a=>a.label == \"Grapple\");\n                    if(aef)\n                    await tactor.deleteEmbeddedEntity(\"ActiveEffect\", aef._id);\n                }\n            });\n        }\n    }else{\n        await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n    }\n} else if (args[0] === \"each\") {\n    if(game.cub.hasCondition(\"Restrained\", tactor) && lastArg == args[1]){\n        await aactor.rollSkill('ath').then(async (result) => {\n            let res = await tactor.rollSkill(skill, {flavor, fastforward: true});\n            if(result.total <= res.total){\n                await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n            }\n        });\n    }else if(game.cub.hasCondition(\"Restrained\", tactor) && DC != false){\n        await tactor.rollSkill(skill, {flavor, fastforward: true}).then(async (result) => {\n            if(result.total >= DC){\n                await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n            }\n        })\n         \n    }\n} else if (args[0] === \"off\") {\n// do any clean up\n}","author":"X4uo406iXTm4HkVN","img":"modules/combat-utility-belt/icons/grappled.svg","actorIds":[]}
{"_id":"hpkqSIiiNHkFWYpO","name":"DAEAttack","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// DAEAttack @item|itemName\n// DAEAttack @token @target @item|itemname\n//console.log(\"ON ATACK\", args);\nif(!args) return;\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nconsole.log(\"ARGS\",args);\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nif (args.length > 3) tactor = canvas.tokens.get(args[2]).actor;\n\nlet org = (lastArg.origin != undefined)?lastArg.origin.split('.'):args[1];\nlet atoken = (args.length > 3) ? canvas.tokens.get(args[1]) : _token;\n\nlet item;\n\nlet origitem = lastArg.efData.flags.dae.itemData;\nif(args.length < 3) item = atoken.actor.items.find(i => i.id === origitem._id);\nif(args.length == 3) item = (typeof args[1] === 'string') ? atoken.actor.items.find(i => i.name === args[1]) : atoken.actor.items.find(i => i.id === args[1]._id);\nif(args.length > 3) item = (typeof args[3] === 'string') ? atoken.actor.items.find(i => i.name === args[3]) : atoken.actor.items.find(i => i.id === args[3]._id);\n\n\nconsole.log(\"DAMAGE\",item, origitem);\nlet aCondition = (origitem)?origitem.data.activation.condition: item.data.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nconsole.log(\"Conditions\",conditions, aCondition);\n\nlet rm = await DAEConditions.execute(conditions, tactor);\nif(args[0] == \"on\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n        item.roll();\n    }\n}else if(args[0] == \"each\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n        item.roll();\n    }else{\n        await atoken.actor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n    }\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/weapon_23.jpg","actorIds":[]}
{"_id":"ilOnM4PONpYPZ8uV","name":"RollTable: Erro Crítico","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"icons/svg/d20-grey.svg","tooltip":"RollTable: Erro Critico","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.getName(\"Erro Crítico\").draw();","author":"X4uo406iXTm4HkVN","img":"icons/svg/d20-black.svg","actorIds":[]}
{"_id":"kFAk71loNB02sUsD","name":"DAECenterToken","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"//@token\nconst lastArg = args[args.length-1];\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId);\nlet atoken = canvas.tokens.get(args[1])\n\nif(args[0] === 'on'){\n    tactor.update({x: atoken.center.x, y: atoken.center.y});\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/yellow_34.jpg","actorIds":[]}
{"name":"EnlargeReduce","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.tKKbvoCkf5A37rsc"},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"//DAE Macro Execute, Effect Value = \"Macro Name\" @target \n\n/**\n * For each target, the GM will have to choose \n */\nlet target = canvas.tokens.get(args[1]);\nlet originalSize = target.data.width;\nlet mwak = target.actor.data.data.bonuses.mwak.damage;\n\nif (args[0] === \"on\") {\n    new Dialog({\n        title: \"Enlarge or Reduce\",\n        buttons: {\n            one: {\n                label: \"Enlarge\",\n                callback: () => {\n                    let bonus = mwak + \" 1d4\";\n                    let enlarge = (originalSize + 1);\n                    target.actor.update({ \"data.bonuses.mwak.damage\": bonus });\n                    target.update({ \"width\": enlarge, \"height\": enlarge });\n                    target.actor.setFlag('world', 'enlageReduceSpell', {\n                        size: originalSize,\n                        ogMwak: mwak,\n                    });\n                    ChatMessage.create({ content: target.name + \" is enlarged\" });\n                }\n            },\n            two: {\n                label: \"Reduce\",\n                callback: () => {\n                    let bonus = mwak + \" -1d4\";\n                    let size = originalSize;\n                    let newSize = (size > 1) ? (size - 1) : (size - 0.3);\n                    target.actor.update({ \"data.bonuses.mwak.damage\": bonus });\n                    target.update({ \"width\": newSize, \"height\": newSize });\n                    target.actor.setFlag('world', 'enlageReduceSpell', {\n                        size: originalSize,\n                        ogMwak: mwak,\n                    });\n                    ChatMessage.create({ content: target.name + \" is reduced\" });\n                }\n            },\n        }\n    }).render(true);\n}\nif (args[0] === \"off\") {\n    let flag = target.actor.getFlag('world', 'enlageReduceSpell');\n    target.actor.update({ \"data.bonuses.mwak.damage\": flag.ogMwak });\n    target.update({ \"width\": flag.size, \"height\": flag.size });\n    target.actor.unsetFlag('world', 'enlageReduceSpell');\n    ChatMessage.create({ content: target.name + \" is returned to normal size\" });\n}","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/link-blue-2.jpg","actorIds":[],"_id":"lsauMPfelmTKiq2E"}
{"_id":"octT6lsJNX0dCiKV","name":"DAEGrapple","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// Grapple true\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nlet org = lastArg.origin.split('.');\nlet aactor = game.actors.get(org[1]);\nlet skill = (tactor.data.data.skills.ath.total >= tactor.data.data.skills.acr.total) ? 'ath' : 'acr';\nlet item = lastArg.efData.flags.dae.itemData;\nconst DC = (lastArg == args[1]) ? false : parseInt(item.data.save.dc);\n\nlet flavor = '';\nlet aCondition = item.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nlet rm = await DAEConditions.execute(conditions, tactor);\nif (args[0] === \"on\") {\n    if((conditions && rm == conditions.length) || conditions == false){\n        if(token.id != lastArg.tokenId && lastArg == args[1]){\n            await aactor.rollSkill('ath').then(async (result) => {\n                let res = await tactor.rollSkill(skill, {flavor, fastforward: true});\n                if(result.total <= res.total){\n                    await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n                }\n            });\n        }\n    }else{\n        await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n    }\n} else if (args[0] === \"each\") {\n    if(game.cub.hasCondition(\"Grappled\", tactor) && lastArg == args[1]){\n        await aactor.rollSkill('ath').then(async (result) => {\n            let res = await tactor.rollSkill(skill, {flavor, fastforward: true});\n            if(result.total <= res.total){\n                await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n            }\n        });\n    }else if(game.cub.hasCondition(\"Grappled\", tactor) && DC != false){\n        await tactor.rollSkill(skill, {flavor, fastforward: true}).then(async (result) => {\n            if(result.total >= DC){\n                await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n            }\n        })\n         \n    }\n} else if (args[0] === \"off\") {\n// do any clean up\n}","author":"X4uo406iXTm4HkVN","img":"modules/combat-utility-belt/icons/grappled.svg","actorIds":[]}
{"_id":"qozoBrs5Q7KT49Mm","name":"Until Save","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"scope":"global","command":"// Two versions one that fetches damage/save/dc from item and one that use args like \n// macro.execute CUSTOM \"Until Save\" cha 15 \n// Get some useful info.\n// active conition (requer uma condição especifica apra o efeito funcionar)\n\nconst lastArg = args[args.length-1];\nconsole.log(\"Until Save args are \", ...args);\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\nlet item = lastArg.efData.flags.dae.itemData;\nlet aCondition = item.data.activation.condition;\nlet conditions = (aCondition)? aCondition.split(','):false;\n\nconsole.log(conditions)\n\nif (args[0] === \"on\") {\n    // Do any setup/first application as required.\n    let rm = 0;\n    let verif\n    if(conditions != false){\n        for (let c of conditions){\n            let cond = c.split(':');\n            cond[0] = cond[0].trim();\n            switch (cond[0]) {\n                case 'Condition':\n                    if(game.cub.hasCondition(cond[1].trim(), tactor)) rm ++;\n                    break;\n                case 'Size':\n                    if(tactor.data.data.traits.size == cond[1].trim()) rm++;\n                    break;\n                case 'Alignment':\n                    verif = tactor.data.data.details.alignment.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                case 'Type':\n                    verif = tactor.data.data.details.type.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                default:\n            }\n        }\n        if(rm != conditions.length){\n            await tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n        }\n    }\n} else if (args[0] === \"each\") {\n  const saveType = (args[1] && args[1] != lastArg)? args[1]: item.data.save.ability;\n  const DC = (args[2] && args[2] != lastArg)? args[2]: item.data.save.dc;\n  const flavor = `${CONFIG.DND5E.abilities[saveType]} DC${DC} ${item?.name || \"\"}`;\n  let save = (await tactor.rollAbilitySave(saveType, {flavor, fastforward: true})).total; \n  if (save > DC) {\n    if (tactor) tactor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId); \n    // remove the effect, this macro will be called again with \"off\" when the effect has been deleted.\n  }else if(item.data.formula){\n      let dd = item.data.formula.split('[');\n      let dtype =(dd.length > 1) ? dd[1].slice(0, -1):item.data.damage.parts[0][1];\n      console.log(dd, dtype)\n        let damageRoll = new Roll(dd[0]).roll(); // could be passed as an argument\n        new MidiQOL.DamageOnlyWorkflow(actor, token, damageRoll.total, dtype, [token], damageRoll, {flavor: `Failed Save for ${item.name} - damage type ${dtype}`, item})\n\n  }\n} else if (args[0] === \"off\") {\n// do any clean up\n}","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.4_03.png","actorIds":[]}
{"_id":"w8MExLHMIGt1K4KO","name":"RollTable: Acerto Crítico","permission":{"default":0,"X4uo406iXTm4HkVN":3},"type":"script","flags":{"macro-marker":{"activeData":{"icon":"icons/svg/d20-grey.svg","tooltip":"RollTable: Acerto Crítico","colour":"#ff0000","trigger":""}},"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_vd9wmfl2y6","path":"Roll Tables","color":"#008000"}},"scope":"global","command":"game.tables.getName(\"Acerto Crítico\").draw();","author":"X4uo406iXTm4HkVN","img":"icons/vtt-512.png","actorIds":[]}
{"_id":"VGYTyo5xF7Bs2Vlb","name":"DAE Life Drain","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/violet_28.jpg","scope":"global","command":"const lastArg = args[args.length-1];\nlet adamage = args[1];\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\n\n\nif (args[0] === \"on\") {\n    let max = tactor.data.data.attributes.hp.max - (adamage);\n    tactor.update ({\n        \"data.attributes.hp.max\": max\n    });\n}\nif (args[0] === \"off\") {\n    let max = tactor.data.data.attributes.hp.max + (adamage);\n    tactor.update ({\n        \"data.attributes.hp.max\": max\n    });\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"hpkqSIiiNHkFWYpO","name":"DAEAttack","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/weapon_23.jpg","scope":"global","command":"// DAEAttack @item|itemName\n// DAEAttack @token @target @item|itemname\n//console.log(\"ON ATACK\", args);\nif(!args) return;\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nconsole.log(\"ARGS\",args);\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nif (args.length > 3) tactor = canvas.tokens.get(args[2]).actor;\n\nlet org = (lastArg.origin != undefined)?lastArg.origin.split('.'):args[1];\nlet atoken = (args.length > 3) ? canvas.tokens.get(args[1]) : _token;\n\nlet item;\n\nlet origitem = lastArg.efData.flags.dae.itemData;\nif(args.length < 3) item = atoken.actor.items.find(i => i.id === origitem._id);\nif(args.length == 3) item = (typeof args[1] === 'string') ? atoken.actor.items.find(i => i.name === args[1]) : atoken.actor.items.find(i => i.id === args[1]._id);\nif(args.length > 3) item = (typeof args[3] === 'string') ? atoken.actor.items.find(i => i.name === args[3]) : atoken.actor.items.find(i => i.id === args[3]._id);\n\n\nconsole.log(\"DAMAGE\",item, origitem);\nlet aCondition = (origitem)?origitem.data.activation.condition: item.data.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nconsole.log(\"Conditions\",conditions, aCondition);\n\nlet rm = await DAEConditions.execute(conditions, tactor);\nif(args[0] == \"on\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n        item.roll();\n    }\n}else if(args[0] == \"each\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n        item.roll();\n    }else{\n        await atoken.actor.deleteEmbeddedEntity(\"ActiveEffect\", lastArg.effectId);\n    }\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"Zkr624s95L1GMhDn","name":"DAEAttackEnd","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/violet_20.jpg","scope":"global","command":"// DAEAttackEnd @item|itemName\nif(args){\nconst lastArg = args[args.length-1];\nlet DAEConditions = game.macros.getName(\"DAEConditions\");\nconsole.log(\"ARGS\",args);\n\nlet ttoken =  canvas.tokens.get(lastArg.tokenId);\nlet tactor = ttoken.actor;\n\nlet org = (lastArg.origin != undefined) ? lastArg.origin.split('.') : args[1];\n\nconsole.log(ttoken.name);\n\nlet item= tactor.items.getName(args[1]);\n\nconsole.log(\"DAMAGE\",item);\nlet aCondition = item.data.data.activation.condition;\nlet conditions = (aCondition) ? aCondition.split(';'):false;\nconsole.log(\"Conditions\",conditions, aCondition);\n\nlet rm = await DAEConditions.execute(conditions, tactor);\n\nif(args[0] == \"off\"){\n    if((conditions && rm == conditions.length) || conditions == false){\n         new MidiQOL.DamageOnlyWorkflow(actor, token, damageRoll.total, dtype, [token], damageRoll, {flavor: `Failed Save for ${item.name} - damage type ${dtype}`, item});\n    }\n}\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"9x6dLAlAaqygjfmS","name":"DAEAura","type":"script","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","scope":"global","command":"// DAEAura @token\nif(args[1] == 0) return;\nif(args[0] == \"off\") return;\nlet atarget=[];\nconst lastArg = args[args.length-1];\nif(args[0] == \"each\" || \"on\") {\n    let damage = \"1d6\";\n    let dtype = \"\";\n\n    let org = lastArg.origin.split('.');\n    let aactor = game.actors.get(org[1]);\n    console.log(aactor, \"ACtor\");\n    let tactor = canvas.tokens.get(lastArg.tokenId);\n    let item = aactor.items.find(i => i.id === org[3]);\n    let ttoken = await canvas.tokens.placeables.find(x=>x.actor.id == org[1]);\n    console.log(ttoken, \"token\");\n    let saveTargets = game.user.targets;\n    game.user.targets = new Set(atarget);\n    try {\n            item.roll();\n        } finally {\n            game.user.targets = saveTargets;\n        }\n    \n    \n    /*\n    let damageRoll = new Roll(damage).roll(); // could be passed as an argument\n    new MidiQOL.DamageOnlyWorkflow(aactor, ttoken, damageRoll.total, dtype, [tactor], damageRoll, {flavor: `Damage from Aura ${item.name} - damage type ${dtype}`, item})\n    */\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"8VJiqz5mdiN7Qgga","name":"DAEAurax","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/wind-grasp-magenta-2.jpg","scope":"global","command":"// DAEAura @token @item self\nconsole.log(args);\nlet atoken = canvas.tokens.get(args[1]);\nlet lastArg = args[args.length-1];\nlet effectId = lastArg.effectId;\nlet atarget=[];\nlet self = (args[3]!== lastArg && args[3] == 'self') ? true : false;\nif(args[0] === 'on' || args[0] === 'each'){\n    if(self && atoken.actor.id != lastArg.actorId) return;\n    canvas.tokens.placeables.map(entity=>{\n        entity.actor.effects.map(ef=>{\n            if(ef.data.origin == lastArg.origin && ef.data.label == lastArg.efData.label){\n                if(entity.actor.id == lastArg.actorId && self){\n                    atarget.push(entity);\n                }else if(entity.actor.id != lastArg.actorId){\n                    atarget.push(entity);\n                }\n            }\n        });\n    });\n    console.log(atoken, atarget);\n    let saveTargets = game.user.targets;\n        game.user.targets = new Set(atarget);\n        try {\n            let damageItem = (typeof args[2] === 'string') ? atoken.actor.items.find(i => i.name === args[2]) : atoken.actor.items.find(i => i.id === args[2]._id);\n            console.log(damageItem);\n            damageItem.roll();\n        } finally {\n            game.user.targets = saveTargets;\n        }\n    \n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"kFAk71loNB02sUsD","name":"DAECenterToken","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/skills/yellow_34.jpg","scope":"global","command":"//@token\nconst lastArg = args[args.length-1];\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId);\nlet atoken = canvas.tokens.get(args[1])\n\nif(args[0] === 'on'){\n    tactor.update({x: atoken.center.x, y: atoken.center.y});\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"8oJ4SPjhNWFb7Fn1","name":"DAEConditions","type":"script","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","scope":"global","command":"// args[0] = conditions\n//args[1] = tactor;\nlet rm = 0;\nlet verif;\nlet sTypes;\n    if(args[0] != false){\n        for (let c of args[0]){\n            let cond = c.split(':');\n            cond[0] = cond[0].trim();\n            switch (cond[0]) {\n                case 'Condition':\n                    if(game.cub.hasCondition(cond[1].trim(), args[1])) rm ++;\n                    break;\n                case 'Size':\n                    sTypes = cond[1].trim().split(',');\n                    if(sTypes.includes(args[1].data.data.traits.size)) rm++;\n                    break;\n                case 'Alignment':\n                    verif = args[1].data.data.details.alignment.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                case 'Type':\n                    verif = args[1].data.data.details.type.trim().toLowerCase();\n                    if(verif.inclides(cond[1].trim().toLowerCase())) rm++;\n                    break;\n                default:\n            }\n        }\n    }\n    return rm;","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"},"advanced-macros":{"runAsGM":false}}}
{"_id":"Rue2uR5U72u8ND7v","name":"DAEDamage","type":"script","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.4_85.png","scope":"global","command":"// DAEDamage 1d6 cold\nconst lastArg = args[args.length-1];\nlet atype = args[2]\nlet adamage = args[1]\nlet ttoken = canvas.tokens.get(lastArg.tokenId);\nlet org = lastArg.origin.split('.');\n\nlet aactor = (org[0]== \"Actor\")? game.actors.get(org[1]):canvas.tokens.get(org[3]).actor;\n\nlet casterItem = lastArg.efData.flags.dae.itemData;\n//let casterItem = aactor.items.find(x=> x.id == org[3]).data;\nconsole.log(casterItem, args, \"ORGS\");\n/*\nconsole.log(\"BBBBBB\");\nconst lastArg = args[args.length-1];\nlet tactor; \nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\nlet ttoken = canvas.tokens.get(lastArg.tokenId);\nlet org = lastArg.origin.split('.');\nlet aactor = (org[0]== \"Actor\")? game.actors.get(org[1]):canvas.tokens.get(org[3]).actor;\nlet adamage = args[1];\nlet atype = args[2];\nlet atoken = (org[2]== \"Item\")?canvas.tokens.placeables.find(z=>z.actor.items.find(x=>x.id == org[3])): null;\nlet casterItem = aactor.items.find(x=> x.id == org[3]);\n\nif (args[0] === \"each\" || \"on\") {\n    let damageRoll = new Roll(adamage,{async:false}).roll();\n    console.log(aactor, atoken, damageRoll, atype, ttoken, casterItem);\n    new MidiQOL.DamageOnlyWorkflow(aactor, atoken, damageRoll.total, atype, [ttoken], damageRoll,{flavor: `Damage type - (${atype})`, itemCardId: \"new\", itemData: casterItem});\n}\n*/\nif (args[0] === \"each\" || \"on\") {\n    //let item = _token.actor.items.contents[0].data;\n    //console.log(item,casterItem,\"ITEM\");\n    let damageRoll = new Roll(adamage,{async:false}).roll();\n    new MidiQOL.DamageOnlyWorkflow(aactor,_token,damageRoll.total,atype,[ttoken], damageRoll,{itemCardId: \"new\", itemData:casterItem});\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"},"advanced-macros":{"runAsGM":false}}}
{"_id":"octT6lsJNX0dCiKV","name":"DAEGrapple","type":"script","author":"X4uo406iXTm4HkVN","img":"modules/combat-utility-belt/icons/grappled.svg","scope":"global","command":"// Grapple true DC\nconst lastArg = args[args.length-1];\nlet tactor; \nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\nlet org = lastArg.origin.split('.');\nlet aactor = (org[0]== \"Actor\")? game.actors.get(org[1]):canvas.tokens.get(org[3]).actor;\nlet skill = (tactor.data.data.skills.ath.total >= tactor.data.data.skills.acr.total) ? 'ath' : 'acr';\nlet item = lastArg.efData.flags.dae.itemData;\nlet DC = (args[2] != lastArg) ? args[2] : (args[1] != lastArg && item.data.save.dc)? parseInt(item.data.save.dc):false;\n//console.log(\"DC\", DC, args, item.data.save.dc);\n\nasync function CheckGrapple(tactor, item){\n    let aef = tactor.getEmbeddedCollection(\"ActiveEffect\").find(a => a.data.label == \"Unconscious\" || a.data.label == \"Dead\");\n    if(aef) return;\n    let sameName = tactor.getEmbeddedCollection(\"ActiveEffect\").filter(a => a.data.label == lastArg.efData.label);\n    if(sameName.length > 1) return;\n    let DAEConditions = game.macros.getName(\"DAEConditions\");\n    let aCondition = item.data.activation.condition;\n    let conditions = (aCondition) ? aCondition.split(';'):false;\n    let rm = (await DAEConditions.execute(conditions, tactor));\n    //precisa retornar só o que leva ao greaple\n    if((_token.id == lastArg.tokenId) || (conditions != false && rm != conditions.length)) return;\n    console.log(\"Conditions\", conditions, rm);\n    return true;\n}\n\nasync function Grapple(aactor, tactor, skill, dc, auto=false){\n    if(auto == true ) return;\n    let flavor = (typeof dc === 'number')?`vs DC: ${dc}`:\"\";\n    let grapple = (await tactor.rollSkill(skill, {flavor: flavor, fastforward: true}).then(async (result) => {\n        if(dc && result.total < dc ) return true;\n        let res = (await aactor.rollSkill('ath', {fastforward: true}));\n        if(result.total < res.total) return true;\n        }));\n    if(grapple) return;\n    await RemoveGrapple(tactor, lastArg.efData.label);\n}\n\nasync function RemoveGrapple(tactor, effectName){\n    let eff = tactor.getEmbeddedCollection(\"ActiveEffect\");\n    let effact = eff.filter(a=>a.data.label == effectName);\n    await tactor.deleteEmbeddedDocuments(\"ActiveEffect\", [effact[0].id]);\n}\n\nif (args[0] === \"on\") {\n    let attpempt = (await CheckGrapple(tactor, item));\n    if(!attpempt){ \n        console.log(\"RECUSADO\");\n        await RemoveGrapple(tactor, lastArg.efData.label);\n        return;\n    }\n    if(args[1] == \"auto\") return;\n    await Grapple(aactor, tactor, skill, lastArg.efData.label, DC, args[1])\n}\nif (args[0] === \"each\") {\n    let d = Dialog.confirm({\n        title: \"Grappler\",\n        content: \"<p>Você está agarado!</p><p>Deseja escapar do agarrão?</p>\",\n        yes: async() => {\n            let attpempt = await CheckGrapple(tactor, item);\n            if(!attpempt){ \n                await RemoveGrapple(tactor, lastArg.efData.label);\n                return;\n            }\n            await Grapple(aactor, tactor, skill, lastArg.efData.label, DC, args[1])\n            \n        },\n        no: () => console.log(\"You chose ... poorly\"),\n        defaultYes: false\n    });\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"},"advanced-macros":{"runAsGM":false}}}
{"_id":"1WjzN8HKjr3Q02W6","name":"DAERollTable","type":"script","author":"X4uo406iXTm4HkVN","img":"icons/svg/d20.svg","scope":"global","command":"//DAERollTable Tablename\nif(args[0] === \"each\"){\n    game.tables.getName(args[1]).draw();\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"Hfmoyuuz29aupbRc","name":"DAESelfRepeat","type":"script","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.2_72.png","scope":"global","command":"// usado apra marcar qual inimigo vai repetir o ataque\n// SelfRepeat Engulf end\n\nconst lastArg = args[args.length-1];\nlet effectId = lastArg.effectId;\nlet macroRepeat = (args[2] && args[2] != lastArg)? 'endEveryTurn':'startEveryTurn';\n\nconsole.log(\"Self Repeat args are \", ...args);\nlet tgtoken;\nlet tgactor;\nif (lastArg.tokenId){\n    tgtoken = canvas.tokens.get(lastArg.tokenId);\n    tgactor = tgtoken.actor;\n} \nelse tgactor = game.actors.get(lastArg.actorId);\n\nlet org = lastArg.origin.split('.');\nlet orgItem = lastArg.efData.flags.dae.itemData;\nlet aCondition = orgItem.data.activation.condition;\nlet conditions = (aCondition)? aCondition.split(',') : false;\n\nlet REPEAT_EFFECT = {\n    label: `Repeat_${tgtoken.name}`,\n    icon: lastArg.efData.icon,\n    changes: [\n      {key: \"macro.execute\", \n      value: `DAEAttack ${_token.id} ${lastArg.tokenId} ${args[1]}`, \n      mode: ACTIVE_EFFECT_MODES.CUSTOM\n      }\n    ],\n    flags: {\n        dae: {\n            macroRepeat: macroRepeat\n        }\n    },\n    transfer: true,\n  };\n  if(args[0] === 'on'){\n    let activeConditions = await _token.actor.getEmbeddedCollection(\"ActiveEffect\")\n    .find(a=> a.label === `Repeat_${tgtoken.name}`);\n    if(!activeConditions){\n        let upItem = Object.assign(REPEAT_EFFECT, {_id: lastArg.efData._id});\n        await _token.actor.createEmbeddedDocuments(\"ActiveEffect\", [REPEAT_EFFECT]);  \n    }\n  }","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"},"advanced-macros":{"runAsGM":false}}}
{"name":"DAESwallow","type":"script","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","scope":"global","command":"//DAESwallow \"tiny,sm,med,lg,huge,grg\" Grappled\nconst lastArg = args[args.length-1];\nlet tactor; \nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\nlet allowSizes = args[1].split(',');\nlet allowSwallow = false;\n\nasync function CheckSwollow(tactor, allowSizes){\n    if(!allowSizes.includes(tactor.data.data.traits.size)) return;\n    if(!game.cub.hasCondition(\"Restrained\", tactor)) return;\n    return true;\n}\n\nasync function RemoveAE(tactor, effectName){\n    let eff = tactor.getEmbeddedCollection(\"ActiveEffect\");\n    let effact = eff.find(a=>a.data.label == effectName);\n    await tactor.deleteEmbeddedDocuments(\"ActiveEffect\", [effact.id]);\n}\n\nif(args[0] == \"on\"){\n    allowSwallow = (await CheckSwollow(tactor, allowSizes));\n    if(allowSwallow){\n        console.log(\"PODE SER ENGULIDO\");\n        await RemoveAE(tactor, args[2]);\n    }\n}\n\nif(args[0] == \"each\"){\n    \n}\n\nif(args[0] == \"off\"){\n    \n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}},"_id":"R8La8H8b6C1upZRk"}
{"_id":"lsauMPfelmTKiq2E","name":"EnlargeReduce","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/link-blue-2.jpg","scope":"global","command":"//DAE Macro Execute, Effect Value = \"Macro Name\" @target \n\n/**\n * For each target, the GM will have to choose \n */\nlet target = canvas.tokens.get(args[1]);\nlet originalSize = target.data.width;\nlet mwak = target.actor.data.data.bonuses.mwak.damage;\n\nif (args[0] === \"on\") {\n    new Dialog({\n        title: \"Enlarge or Reduce\",\n        buttons: {\n            one: {\n                label: \"Enlarge\",\n                callback: () => {\n                    let bonus = mwak + \" 1d4\";\n                    let enlarge = (originalSize + 1);\n                    target.actor.update({ \"data.bonuses.mwak.damage\": bonus });\n                    target.update({ \"width\": enlarge, \"height\": enlarge });\n                    target.actor.setFlag('world', 'enlageReduceSpell', {\n                        size: originalSize,\n                        ogMwak: mwak,\n                    });\n                    ChatMessage.create({ content: target.name + \" is enlarged\" });\n                }\n            },\n            two: {\n                label: \"Reduce\",\n                callback: () => {\n                    let bonus = mwak + \" -1d4\";\n                    let size = originalSize;\n                    let newSize = (size > 1) ? (size - 1) : (size - 0.3);\n                    target.actor.update({ \"data.bonuses.mwak.damage\": bonus });\n                    target.update({ \"width\": newSize, \"height\": newSize });\n                    target.actor.setFlag('world', 'enlageReduceSpell', {\n                        size: originalSize,\n                        ogMwak: mwak,\n                    });\n                    ChatMessage.create({ content: target.name + \" is reduced\" });\n                }\n            },\n        }\n    }).render(true);\n}\nif (args[0] === \"off\") {\n    let flag = target.actor.getFlag('world', 'enlageReduceSpell');\n    target.actor.update({ \"data.bonuses.mwak.damage\": flag.ogMwak });\n    target.update({ \"width\": flag.size, \"height\": flag.size });\n    target.actor.unsetFlag('world', 'enlageReduceSpell');\n    ChatMessage.create({ content: target.name + \" is returned to normal size\" });\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.tKKbvoCkf5A37rsc"},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"KGYWNvGt3zgVU1A9","name":"Invisibility","type":"script","author":"X4uo406iXTm4HkVN","img":"systems/dnd5e/icons/spells/fog-sky-2.jpg","scope":"global","command":"//DAE Macro Execute, Effect Value = \"Macro Name\" @target\n\nlet target = canvas.tokens.get(args[1])\nif (args[0] === \"on\") {\n    ChatMessage.create({ content: `${target.name} turns invisible` });\n    target.update({ \"hidden\": true });\n}\nif (args[0] === \"off\") {\n    ChatMessage.create({ content: `${target.name} re-appears` });\n    target.update({ \"hidden\": false });\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"51UjG9KrG0bzOCqO","name":"Reoccuring Effect","type":"script","author":"iv1xD7Xolui8SRLL","img":"systems/dnd5e/icons/skills/affliction_02.jpg","scope":"global","command":"// arguments\n//args[0] --> \"on\", \"each\", \"off\"\n//args[1] --> the level the spell was cast (usually @item.level)\n//args[2] --> save allowed (\"yes\"/\"no\"), e.g. damage effects that can only be ended using an action)\n//args[3] --> damage mode \n//              \"none\" for effects without damage\n//              \"flat\" for fixed damage from argument baseDamage\n//              \"scaling\" for damage scaling based on castLevel\n//args[4] --> damage type\n//args[5] --> baseDamage (e.g. 1d6)\n//args[6] --> scalingDieCount (e.g. 2 for 2dX scaling per spell level)\n//args[7] --> scalingDieSize (e.g. d6 for Xd6 scaling per spell level)\n//args[8] --> saveType (if spell does not contain a saving throw, e.g. Paladin smites)\n//args[9] --> flat DC\n\nif (args[0] === \"each\") {\n\n  const lastArg = args[args.length-1];\n  const castLevel = args[1];\n  const saveAllowed = args[2];\n  const damageMode = args[3];\n  const damageType = args[4];\n  const baseDamage = args[5];\n  const scalingDieCount = args[6];\n  const scalingDieSize = args[7];\n  let saveType = args[8];\n  let dc = args[9];\n\n  let target;\n  if (lastArg.tokenId) target = canvas.tokens.get(lastArg.tokenId);\n    else target = game.actors.get(lastArg.actorId).getActiveTokens(0);\n  const effect = lastArg.effectId;\n  const casterItem = lastArg.efData.flags.dae.itemData;\n  const casterItemLevel = casterItem.data.level;\n  const [_1, casterId, _2, _3] = lastArg.efData.origin.split(\".\")\n  const caster = game.actors.get(casterId);\n  const casterT = caster.isToken ? caster.token : caster.getActiveTokens[0];\n\n  let effectEnds;\n  \n  //Determine saveType and dc if save is allowed and ask for save\n  //Priority for save: 1) values in args[8] and args[9]\n  //          2) values stored in the item\n  if (saveAllowed === \"yes\") {\n      if (saveType === null) {\nChatMessage.create({ content: \"Hallo\" });   \n        saveType = casterItem.data.save.ability;\n        dc = casterItem.data.save.dc;\n      }\n      const flavor = `${CONFIG.DND5E.abilities[saveType]} DC${dc} ${casterItem.name}`;  \n      let save = (await target.actor.rollAbilitySave(saveType, {flavor, fastforward: true, chatMessage: true}));\n      if (save.total >= dc) effectEnds = true;\n        else effectEnds = false;\n  } else effectEnds = false;\n\n\n  //Delete effect if saved; otherwise do damage, if effect has damage over time\n  if (effectEnds) {\n    if (target) target.actor.deleteEmbeddedEntity(\"ActiveEffect\", effect);\n  } else {\n    let damageRoll;\n    if (damageMode != \"none\") {\n      let damageFormula;\n      if (damageMode === \"scaling\" && castLevel-casterItemLevel > 0) {\n        damageFormula = baseDamage + \"+\" + (castLevel-casterItemLevel) * scalingDieCount + scalingDieSize;\n      } else {\n        damageFormula = baseDamage;\n      }\n      damageRoll = new Roll(damageFormula).roll();\n      new MidiQOL.DamageOnlyWorkflow(caster, casterT, damageRoll.total, damageType, [target], damageRoll, {flavor: `Damage for ${casterItem.name}`, itemCardId: \"new\", itemData: casterItem})\n    }\n  }\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false},"exportSource":{"world":"testWorld","system":"dnd5e","coreVersion":"0.7.9","systemVersion":"1.2.4"},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"}}}
{"_id":"qozoBrs5Q7KT49Mm","name":"Until Save","type":"script","author":"X4uo406iXTm4HkVN","img":"assets/icons/icones-flat/Icon.4_03.png","scope":"global","command":"// Two versions one that fetches damage/save/dc from item and one that use args like \n// macro.execute CUSTOM \"Until Save\" cha 15 \n// Get some useful info.\n// active conition (requer uma condição especifica apra o efeito funcionar)\n\nconst lastArg = args[args.length-1];\n\nconsole.log(\"Until Save args are \", ...args);\nlet tactor;\nif (lastArg.tokenId) tactor = canvas.tokens.get(lastArg.tokenId).actor;\nelse tactor = game.actors.get(lastArg.actorId);\nlet org = lastArg.origin.split('.');\nlet aactor = (org[0]== \"Actor\")? game.actors.get(org[1]):canvas.tokens.get(org[3]).actor;\nlet item = lastArg.efData.flags.dae.itemData;\n\nasync function CheckSave(tactor, item){\n    let aef = tactor.getEmbeddedCollection(\"ActiveEffect\").find(a => a.data.label == \"Unconscious\" || a.data.label == \"Dead\");\n    if(aef) return;\n    let DAEConditions = game.macros.getName(\"DAEConditions\");\n    let aCondition = item.data.activation.condition;\n    let conditions = (aCondition) ? aCondition.split(';'):false;\n    let rm = (await DAEConditions.execute(conditions, tactor));\n    console.log(\"OTER\", conditions, rm, _token.id, lastArg.tokenId);\n    if((_token.id == lastArg.tokenId) || (conditions != false && rm != conditions.length))return;\n    return true;\n}\nasync function UntilSave(tactor, item, saveType, effectName, DC, flavor){\n   let save = (await tactor.rollAbilitySave(saveType, {flavor, fastforward: true})).total;\n   if (save >= DC){\n       await RemoveCondition(tactor, effectName);\n       return;\n   }\n   if(!item.data.formula) return;\n   let dd = item.data.formula.split('[');\n   let dtype =(dd.length > 1) ? dd[1].slice(0, -1):item.data.damage.parts[0][1];\n   let damageRoll = new Roll(dd[0]).roll();\n   new MidiQOL.DamageOnlyWorkflow(actor, token, damageRoll.total, dtype, [token], damageRoll, {flavor: `Failed Save for ${item.name} - damage type ${dtype}`, item})\n}\nasync function RemoveCondition(tactor, effectName){\n    let eff = tactor.getEmbeddedCollection(\"ActiveEffect\");\n    let effact = eff.filter(a=>a.data.label == effectName);\n    await tactor.deleteEmbeddedDocuments(\"ActiveEffect\", [effact[effact.length -1].id]);\n}\n\nif (args[0] === \"on\") {\n    let attpempt = await CheckSave(tactor, item);\n    if(attpempt)return;\n    await RemoveCondition(tactor, lastArg.efData.label);\n}\nif (args[0] === \"each\") {\n    let saveType = (args[1] && args[1] != lastArg)? args[1]: item.data.save.ability;\n    let DC = (args[2] && args[2] != lastArg)? args[2]: item.data.save.dc;\n    let flavor = `${CONFIG.DND5E.abilities[saveType]} DC${DC} ${item?.name || \"\"}`;\n    \n    await UntilSave(tactor, item, saveType, lastArg.efData.label, DC, flavor);\n}\n\nif (args[0] === \"off\") {\n// do any clean up\n}","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":true},"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000"},"advanced-macros":{"runAsGM":false}}}
{"_id":"RkAsCLVcGEDyK8We","name":"#[CF_tempEntity]","type":"chat","author":"X4uo406iXTm4HkVN","img":"icons/svg/dice-target.svg","scope":"global","command":"","folder":null,"sort":0,"permission":{"default":0,"X4uo406iXTm4HkVN":3},"flags":{"cf":{"id":"temp_2gq0y560gj7","path":"DAE","color":"#800000","name":"DAE","children":["qIRyPTF4E1p6VT8r","hpkqSIiiNHkFWYpO","Zkr624s95L1GMhDn","9x6dLAlAaqygjfmS","kFAk71loNB02sUsD","8oJ4SPjhNWFb7Fn1","Rue2uR5U72u8ND7v","octT6lsJNX0dCiKV","gPmEcO9hroTTBH7t","1WjzN8HKjr3Q02W6","Hfmoyuuz29aupbRc","lUvYFZQ8Ls6tncil","NFOnsUtAmd6FbndR","51UjG9KrG0bzOCqO","qozoBrs5Q7KT49Mm","VGYTyo5xF7Bs2Vlb","8VJiqz5mdiN7Qgga","lsauMPfelmTKiq2E","KGYWNvGt3zgVU1A9","R8La8H8b6C1upZRk"],"folderPath":[]}}}
